name: Branch Push Alert

on:
  push:
    branches:
      - '**'   

jobs:
  check-branch:
    runs-on: ubuntu-latest
    outputs:
      wrong_branch: ${{ steps.check.outputs.wrong_branch }}
    steps:
      - id: check
        run: |
          branch="${{ github.ref_name }}"
          echo "Pushed branch: $branch"

          # âŒ Add restricted branches here
          if [[ "$branch" == "main" || "$branch" == "master" ]]; then
            echo "wrong_branch=true" >> $GITHUB_OUTPUT
            echo "âŒ Wrong branch detected!"
          else
            echo "wrong_branch=false" >> $GITHUB_OUTPUT
            echo "âœ… Safe branch"
          fi

  send-email-alert:
    needs: check-branch
    if: needs.check-branch.outputs.wrong_branch == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Send alert email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 465
          username: ${{ secrets.ALERT_EMAIL_USER }}
          password: ${{ secrets.ALERT_EMAIL_PASS }}
          from: ${{ secrets.ALERT_EMAIL_USER }}
          to: ckambagiriramudu2@gmail.com
          subject: "ğŸš¨ Wrong Branch Push Detected: ${{ github.ref_name }}"
          body: |
            âŒ A push was made to a restricted branch: **${{ github.ref_name }}**

            ğŸ“¦ Repository: ${{ github.repository }}
            ğŸ‘¤ Pusher:     ${{ github.actor }}
            ğŸ”— Commit:     ${{ github.sha }}
            ğŸ“ Message:    ${{ github.event.head_commit.message }}

            ğŸ‘‰ View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
